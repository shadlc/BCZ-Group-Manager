<!DOCTYPE html>
<html dir="ltr" lang="zh-CN" >
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <title>å°ç­æ•°æ®ç®¡ç†</title>
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" href="favicon.ico" />
    <link rel="stylesheet" href="lib/style.css">
  </head>

  <body class="outside-bg">
    <div class="bg-items">
      <span class="high-grass grass-border">
        <span></span><span></span><span></span><span></span><span></span>
      </span>
      <span class="high-grass">
        <span></span><span></span><span></span><span></span><span></span>
      </span>
      <span class="low-grass grass-border">
        <span></span><span></span><span></span><span></span><span></span>
      </span>
      <span class="low-grass">
        <span></span><span></span><span></span><span></span><span></span>
      </span>
      <div id="cloud_container"></div>
    </div>
    <main>
      <div class="wall">
        <div class="eaves">
          <div class="gloss"></div>
          <div class="eaves-container">
            <a id="my_class" class="active">å°ç­åˆ—è¡¨</a>
            <a href="data">æ•°æ®æŸ¥è¯¢</a>
            <a href="setting">ç³»ç»Ÿè®¾ç½®</a>
          </div>
        </div>
        <div class="wall-container">
          <span class="loading-text">
            <div class="loader">
              <span></span>
              <span></span>
              <span></span>
            </div>
            æ•°æ®è·å–ä¸­ï¼Œè¯·ç¨å...
          </span>
          <div id="group_filter" class="search-input hide">
            <span>ğŸ”</span>
            <input type="text" placeholder="ç­›é€‰å°ç­" onkeyup="groupFilter(event)" />
          </div>
          <div class="group empty-group hide" onclick="toggleGroupSearchModal()">
          </div>
        </div>
        </div>
      </div>
      <div class="footer">
        <footer>
          <div class="info">
            <input type="checkbox">
            <span></span>
            <span></span>
            <span></span>
            <div>
              <span><a href="https://github.com/shadlc/BCZ-Group-Manager" target="_blank"><u>BCZ-Group-Manager</u></a> Made By Shadlc</span>
            </div>
          </div>
        </footer>
      </div>
      <div id="refresh_btn" class="left-corner-btn btn" onclick="refresh_data()">åˆ·æ–°</div>
    </main>
    <div id="group_search_modal" class="modal hide" data-status="hidden" onclick="toggleGroupSearchModal(event)">
      <div class="modal-content">
        <span class="modal-close-btn" onclick="toggleGroupSearchModal()"></span>
        <div class="modal-title">æ·»åŠ å°ç­</div>
        <div class="modal-body">
          <div id="group_search">
            <input type="text" id="group_search_input" placeholder="ç­é•¿IDæˆ–16ä½å°ç­åˆ†äº«ç (é6ä½é‚€è¯·ç )" onkeyup="eventSearch(event)" />
            <span class="btn" onclick="searchGroups()">æœç´¢</span>
          </div>
          <div id="group_result">
            <span>ç©ºç©ºå¦‚ä¹Ÿ~</span>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="lib/script.js"></script>
  <script>
    onload = ()=>{
      initCloud(10);
      getInfo()
      .then((info)=>{
        if (!info) return;
        getGroupList();
        bindScrollToTopBtn(document.querySelector('.wall-container'));
      });
    }

    // è·å–é…ç½®ä¿¡æ¯
    function getInfo() {
      return fetch('configure')
      .then(response => response.json())
      .then(data => {
        if (data.retcode != 0) {
          notify(data.msg);
          return;
        }
        return data.data;
      })
      .catch(error => {
        console.error('è¯·æ±‚é”™è¯¯:', error);
        notify('è¯·æ±‚é”™è¯¯:' + error);
      });
    }

    // è°ƒæ•´å°ç­é¡µé¢æ˜¾ç¤º
    function toggle_group_display(show) {
      if (show) {
        document.querySelectorAll('.loading-text').forEach((e)=>{
          e.classList.add('hide');
        });
        document.querySelectorAll('#group_filter').forEach((e)=>{
          e.classList.remove('hide');
        });
        document.querySelectorAll('.group').forEach((e)=>{
          e.classList.remove('hide');
        });
      } else {
        document.querySelectorAll('.loading-text').forEach((e)=>{
          e.classList.remove('hide');
        });
        document.querySelectorAll('#group_filter').forEach((e)=>{
          e.classList.add('hide');
        });
        document.querySelectorAll('.group').forEach((e)=>{
          e.classList.add('hide');
        });
      }
    }

    // è·å–å°ç­ä¿¡æ¯
    function getGroupList(cache_all=false) {
      toggle_group_display(show=false);
      let url = 'observe_group';
      if (cache_all) {
        url += '?cache_all=' + cache_all
      }
      return fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.retcode != 0) {
          notify(data.msg);
          return;
        }
        let groups = data.data;
        document.getElementById('my_class').innerText = 'å°ç­åˆ—è¡¨(' + groups.length + ')';
        document.querySelectorAll('.group:not(.empty-group)').forEach((e)=>{
          e.remove();
        });
        let container = document.querySelector('.wall-container');
        let empty_group = document.querySelector('.empty-group');
        let group_count = Object.keys(groups).length;
        let group_filter = document.getElementById('group_filter');
        if (group_count >= 10) {
          group_filter.classList.remove('hide');
        } else {
          group_filter.classList.add('hide');
        }
        for (let i in groups) {
          let group = groups[i];
          let favorite_checked = '';
          if (group.favorite) {
            favorite_checked = 'checked';
          }
          let group_content = `
            <div class="info-table">
              <div class="avatar">
                <img src="https://vol-v6.bczcdn.com`+group.avatar+`" />
                <img src="`+group.avatar_frame+`" />
              </div>
              <div class="group-info">
                <span>`+group.name+`</span>
                <span>`+group.today_daka_count+`/`+group.member_count+`å·²æ‰“å¡</span>
              </div>
            </div>
            <div class="door">
              <div class="door-glass"></div>
              <div class="door-knob"></div>
              <img class="rank-flag" src="img/s`+group.rank+`.png"/>
            </div>
            <span class="group-favorite `+favorite_checked+`" onclick="addFavorite(event, '`+group.name+`', '`+group.id+`')" >â˜…</span>
          `
          let group_div = document.createElement('div');
          group_div.className = 'group';
          if (group.valid == 2) {
            // notify('å°ç­'+group.name+'çš„æ•°æ®è·å–å¤±è´¥! \nåŸå› ä¸º: '+group.exception);
            group_div.className += ' invalid';
          }
          group_div.innerHTML = group_content;
          group_div.addEventListener('click', (e)=>{
          if (e?.target) {
            if (e?.target.classList.contains('group-favorite')) {
              return;
            }
          }
            window.location.href = 'group/' + group.id;
          });
          container.insertBefore(group_div, empty_group);
        }
        toggle_group_display(show=true);
        return true;
      })
      .catch(error => {
        console.error('è¯·æ±‚é”™è¯¯:', error);
        notify('è¯·æ±‚é”™è¯¯:' + error);
      });
    }

    // æ‰“å¼€å…³é—­å°ç­æœç´¢æ¨¡æ€æ¡†
    function toggleGroupSearchModal(event) {
      if (event?.target) {
        if (event?.target.id != 'group_search_modal') {
          return;
        }
      }
      let modal = document.getElementById('group_search_modal');
      let modal_content = modal.children[0];
      let status = modal.getAttribute('data-status');
      modal.setAttribute('data-status', '');
      if (status == 'show') {
        modal_content.style.transform = 'scale(0.9)';
        modal.style.opacity = 0;
        setTimeout(()=>{
          modal.classList.add('hide');
          modal.setAttribute('data-status', 'hidden');
        }, 500);
      } else if (status == 'hidden') {
        modal.classList.remove('hide');
        modal_content.style.transform = 'scale(0.9)';
        modal.style.opacity = 0;
        setTimeout(()=>{
          modal_content.style.transform = 'scale(1)';
          modal.style.opacity = 1;
        }, 1);
        setTimeout(()=>{
          modal.setAttribute('data-status', 'show');
        }, 500);
      }
    }

    // æœç´¢å°ç­
    function searchGroups() {
      let search_text = document.getElementById('group_search_input').value;
      let container = document.getElementById('group_result');
      let result_span = document.querySelector('#group_result>span');
      let url = 'search_group';
      if (isNaN(search_text) && search_text.length == 16) {
        url += '?share_key=' + search_text;
      } else if (search_text.length) {
        url += '?uid=' + search_text;
      } else {
        notify('æœç´¢æ¡ä»¶ä¸èƒ½ä¸ºç©º(*/Ï‰ï¼¼*)');
        return;
      }
      container.innerHTML = 
        `
          <span class="loading-text">
            <div class="loader">
              <span></span>
              <span></span>
              <span></span>
            </div>
            æ•°æ®è·å–ä¸­ï¼Œè¯·ç¨å...
          </span>
        `;
      fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.retcode != 0) {
          container.innerHTML = '<span>ç©ºç©ºå¦‚ä¹Ÿ~</span>';
          notify(data.msg);
          return;
        }
        document.querySelector('#group_result>span')?.remove();
        let groups = data.data;
        container.innerHTML = '';
        for (let i in groups) {
          let group = groups[i];
          let badges = '';
          if (group.leader === true) {
            badges += '<span class="badge green-border">ç­é•¿</span>';
          } else if (group.leader === false) {
            badges += '<span class="badge blue-border">æˆå‘˜</span>';
          }
          let group_content = `
            <div class="info-table">
              <div class="avatar">
                <img src="https://vol-v6.bczcdn.com`+group.avatar+`" />
                <img src="`+group.avatar_frame+`" />
              </div>
              <div class="group-info">
                <span>`+group.name+`</span>
                <span>å°ç­ID: `+group.id+`</span>
              </div>
              <div class="group-detail">
                <span>äººæ•°`+group.member_count+`/`+group.count_limit+`, å®Œæˆç‡`+Math.round(group.finishing_rate * 100)+`%</span>
                <span>`+group.introduction+`</span>
              </div>
              <div class="group-extra">
                `+badges+`
              </div>
            </div>
          `
          let group_div = document.createElement('div');
          group_div.className = 'group brief';
          group_div.innerHTML = group_content;
          group_div.addEventListener('click', ()=>{
            addObserveGroup(group);
          });
          container.appendChild(group_div);
        }
        if (container.innerHTML == '') {
          container.innerHTML = '<span>ç©ºç©ºå¦‚ä¹Ÿ~</span>';
        }
        return true;
      })
      .catch(error => {
        console.error('è¯·æ±‚é”™è¯¯:', error);
        notify('è¯·æ±‚é”™è¯¯:' + error);
        container.innerHTML = '<span>ç©ºç©ºå¦‚ä¹Ÿ~</span>';
      });
    }

    // äº‹ä»¶è§¦å‘æœç´¢
    function eventSearch(event) {
      if (event.key === "Enter") {
        searchGroups(event?.target?.value);
      }
    }

    // æ·»åŠ å…³æ³¨å°ç­
    function addObserveGroup(group) {
      let content = `
        <line>æ˜¯å¦æ·»åŠ æ­¤å°ç­?</line>
        <div class="modal-text">`
          + `\nå°ç­åç§°: ` + group.name
          + `\nå°ç­ID: ` + group.id
          + `\nåˆ†äº«ç : ` + group.share_key
          + `</div>`;
      showModal(content, 'æ·»åŠ å°ç­', ()=>{
        let payload = {'share_key': group.share_key};
        fetch('observe_group', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        })
        .then(response => {
          return response.json();
        })
        .then(data => {
          notify(data.msg);
        });
      });
    }

    // æ”¶è—å°ç­
    function addFavorite(event, group_name, group_id) {
      let element = event.target;
      let content = `<line>æ˜¯å¦æ”¶è—å°ç­[`+group_name+`]?</line><line>æ”¶è—åå³å¯æ˜¾ç¤ºåœ¨æœ€ä¸Šç«¯</line>`;
      let favorite = 1;
      if (element.classList.contains('checked')) {
        content = `<line>æ˜¯å¦å–æ¶ˆæ”¶è—å°ç­[`+group_name+`]?`;
        favorite = 0;
      }
      showModal(content, 'æ”¶è—å°ç­', ()=>{
        let payload = {'id': group_id, 'favorite': favorite};
        fetch('observe_group', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        })
        .then(response => {
          return response.json();
        })
        .then(data => {
          notify(data.msg);
        });
      });
    }

    // ç­›é€‰å°ç­
    function groupFilter(event) {
      let element = event.target;
      let filter = element.value;
      document.querySelectorAll('.group:not(.empty-group)').forEach((e)=>{
        if (e.innerText.includes(filter)) {
          e.classList.remove('hide');
        } else {
          e.classList.add('hide');
        }
      });
    }

    // åˆ·æ–°å…¨éƒ¨å°ç­æ•°æ®
    function refresh_data() {
      showModal('æ˜¯å¦ä¸ºå½“å‰é¡µé¢å…¨éƒ¨å°ç­è·å–æœ€æ–°æ•°æ®?', 'åˆ·æ–°å…¨éƒ¨', ()=>{
        getGroupList(true);
      });
    }

</script>
</html>