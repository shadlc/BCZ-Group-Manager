<!DOCTYPE html>
<html dir="ltr" lang="zh-CN" >
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <title>小班数据管理</title>
    <link rel="shortcut icon" href="../favicon.ico" />
    <link rel="apple-touch-icon" href="../favicon.ico" />
    <link rel="stylesheet" href="../lib/style.css">
    <style>
      .inside-bg {
        background-color: rgb(255, 245, 216);
      }
    </style>
  </head>

  <body class="inside-bg">
    <main>
      <div class="group-container"></div>
      <div class="paper">
        <div class="input-group hide">
          <div class="input">
            <label for="cheat_select">晚卡时间</label>
            <select id="cheat_select" onkeyup="eventSearch(event)">
              <option value="">任意</option>
              <option value="true" selected>是</option>
              <option value="false">否</option>
            </select>
          </div>
          <div class="input">
            <label for="completed_select">缺卡次数</label>
            <select id="completed_select" onkeyup="eventSearch(event)">
              <option value="">任意</option>
              <option value="true" selected>是</option>
              <option value="false">否</option>
            </select>
          </div>
          <div class="input">
            <label for="user_id_input">用户ID</label>
            <input id="user_id_input" type="number" onkeyup="eventSearch(event)" />
          </div>
          <div class="input">
            <label for="nickname_input">昵称</label>
            <input id="nickname_input" type="text" onkeyup="eventSearch(event)" />
          </div>
          <div class="btn-group">
            <div id="reset_btn" class="btn" onclick="resetSearch()">重置</div>
            <div id="search_btn" class="btn" onclick="queryMemberTable()">查询</div>
            <div id="download_btn" class="btn" onclick="downloadMemberTable(event)">下载</div>
          </div>
        </div>
        <div class="data-container">
        </div>
        <span class="loading-text">
          <div class="loader">
            <span></span>
            <span></span>
            <span></span>
          </div>
          数据获取中，请稍后...
        </span>
      </div>
      <div class="footer">
        <footer>
          <div class="info">
            <input type="checkbox">
            <span></span>
            <span></span>
            <span></span>
            <div>
              <span><a href="https://github.com/shadlc/BCZ-Group-Manager" target="_blank"><u>BCZ-Group-Manager</u></a> Made By Shadlc</span>
            </div>
          </div>
        </footer>
      </div>
    </main>
    <div class="left-corner-btn btn" onclick="backToHome()">回主页</div>
  </body>
  <script src="../lib/script.js"></script>
  <script>
    window.onload = ()=>{
      var href = window.location.href;
      var group_id = href.substring(href.lastIndexOf('/') + 1);
      getGroupInfo(group_id).then((result)=>{
        if (result) {          
          let loading_text = document.querySelector('.loading-text');
          loading_text.innerHTML = '';
          document.querySelector('.input-group').classList.remove('hide');
        }
      }
      )
    }

    // 返回主页
    function backToHome() {
      window.location.href = '../';
    }

    // 打开关闭公告模态框
    function toggleNoticeModal(event) {
      if (event?.target) {
        if (event?.target.id != 'notice_modal') {
          return;
        }
      }
      let modal = document.getElementById('notice_modal');
      let modal_content = modal.children[0];
      let status = modal.getAttribute('data-status');
      modal.setAttribute('data-status', '');
      if (status == 'show') {
        modal_content.style.transform = 'scale(0.9)';
        modal.style.opacity = 0;
        setTimeout(()=>{
          modal.classList.add('hide');
          modal.setAttribute('data-status', 'hidden');
        }, 500);
      } else if (status == 'hidden') {
        modal.classList.remove('hide');
        modal_content.style.transform = 'scale(0.9)';
        modal.style.opacity = 0;
        setTimeout(()=>{
          modal_content.style.transform = 'scale(1)';
          modal.style.opacity = 1;
        }, 1);
        setTimeout(()=>{
          modal.setAttribute('data-status', 'show');
        }, 500);
      }
    }

    // 获取小班信息
    function getGroupInfo(group_id) {
      let loading_text = document.querySelector('.loading-text');
      return fetch('../observe_group?id=' + group_id)
      .then(response => response.json())
      .then(data => {
        if (data.retcode != 0) {
          loading_text.innerHTML = data.msg;
          notify(data.msg);
          return;
        }
        let group = data.data[0];
        setGroupInfo(group);
        setMemberInfo(group);
        return true;
      })
      .catch(error => {
        console.error('请求错误:', error);
        notify('请求错误:' + error);
        loading_text.innerHTML = error;
      });
    }

    // 通过数据设置展示小班信息
    function setGroupInfo(group) {
      let container = document.querySelector('.group-container');
      let group_content = `
        <span class="gloss"></span>
        <span class="eraser" onclick="slideLeft(event)"></span>
        <div class="group brief transparent">
          <div class="info-table">
            <div class="avatar" onclick="rotate(event)">
              <img src="https://vol-v6.bczcdn.com`+group.avatar+`" />
              <img src="`+group.avatar_frame+`" />
            </div>
            <div class="group-info">
            <span>`+group.name+`</span>
            </div>
            <div class="group-detail">
              <span>班长: `+group.leader+`(`+group.leader_id+`)</span>
              <span>人数`+group.member_count+`/`+group.count_limit+`, 完成率`+Math.round(group.finishing_rate * 100)+`%</span>
              <span>`+group.introduction+`</span>
            </div>
          </div>
        </div>
        <img class="rank-flag" src="../img/s`+group.rank+`.png" onclick="sway(event)" />
        <div class="tiny-notice" onclick="toggleNoticeModal()">
          <span>公告</span>
        </div>
        <div id="notice_modal" class="modal hide" data-status="hidden" onclick="toggleNoticeModal(event)">
          <div class="modal-content notice">
            <span class="modal-close-btn" onclick="toggleNoticeModal()"></span>
            <div class="modal-title">小班公告</div>
            <div class="modal-body">
              <div class="modal-text">`+group.notice+`</div>
            </div>
          </div>
        </div>
      `;
      let info_div = document.createElement('div');
      info_div.className = 'blackboard';
      info_div.innerHTML = group_content;
      container.insertBefore(info_div, container.firstChild);
    }

    // 通过数据设置展示成员信息
    function setMemberInfo(group) {
      let container = document.querySelector('.paper');

    }

  </script>
</html>